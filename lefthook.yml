output:
  - success
  - failure

pre-push:
  parallel: true
  jobs:
    - name: go test
      glob: "{internal/*,go.*,*.go}"
      run: go test ./...

# Match to plan.yml
pre-commit:
  parallel: true
  jobs:
    - name: go build
      glob: "{internal/*,go.*,*.go}"
      env:
        CGO_ENABLED: "0"
      run: go build

    - name: golangci-lint
      glob: "{flake.lock,.golangci.yml,*.go}"
      run: |
        golangci-lint fmt
        golangci-lint run --fix
      stage_fixed: true

    # action-validator does not play well with nix-direnv (it scans all files instead of ones in version control)
    # - name: action-validator
    #   run: git ls-files -z '.github/workflows/*.yml' '*/action.yml' | xargs --null action-validator --verbose

    - name: actionlint
      glob: ".github/workflows/*.yml"
      run: actionlint -color

    # https://github.com/anttiharju/relcheck
    - name: relcheck
      run: relcheck all

    - name: editorconfig-checker
      run: editorconfig-checker {staged_files}

    - name: Keep .yml
      glob: "*.yaml"
      run: echo "You are trying to commit .yaml files. Please use .yml instead for the following files:" && echo {staged_files} && exit 1

    - glob: "{docs/*,mkdocs.yml}"
      run: mkdocs build --strict

    - name: prettier
      glob: "{*.yml,*.md}"
      run: prettier --write --no-error-on-unmatched-pattern {staged_files}
      stage_fixed: true

    - name: rubocop
      glob: "{*.rb}"
      run: .release/render.sh brew && find .release/brew -name "*.rb" -type f -not -name "*template.rb" -and -not -name "*.tpl.rb" -exec rubocop {} \;

    - name: shellcheck
      glob: "{*.sh,.shellcheckrc}"
      run: git ls-files -z '*.sh' | xargs --null shellcheck --color=always

    - name: nixfmt
      glob: "*.nix"
      run: nixfmt {staged_files}
      stage_fixed: true
